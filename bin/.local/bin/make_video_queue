#!/bin/sh

find -L "${@:-.}" -type f | sort | video_duration | awk '
BEGIN {
    read_file(sequentials, "sequential.txt")
    read_file(exclude, "exclude.txt")
}

!in_seq(exclude, $0) {
    sequential = in_seq(sequentials, $0)
    if (sequential) {
        items[sequential] += $1
        items_count[sequential] += 1
        if (!(sequential in items_first)) {
            items_first[sequential] = $1
        }
        next
    } else {
        print $0 | "sed -E \"s/^([0-9]+) /\\1|||/\""
    }
}

END {
    for (item in items) {
        print items_first[item] "|" items_count[item] "|" items[item] "|" item | "format_duration 3 \"|\""
    }
}

function read_file(arr, name)
{
    if (system("test -f " name) == 0) {
       i = 1
       while (getline <name) {
           arr[i] = $0
           i = i + 1
       }
    }
}

function in_seq(seq, line)
{
    for (i in seq) {
        if (match(line, seq[i])) {
            return seq[i]
        }
    }
    return 0
}
' | sort -n -t "|" | format_duration 1 "|" | column -t -s "|" -R '1,2,3' -N "DUR,QT,PLIST,NAME"
