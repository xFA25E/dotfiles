#!/bin/sh

unmountusb() {
    drives="${1:?provide drives}"
    chosen="$(echo "${drives}" | rofi -dmenu -i -p "Which drive?" -no-custom | awk '{print $1}')"
    sudo -A umount "${chosen:?}" && notify-send "ðŸ’» USB unmounting" "${chosen} unmounted."
}

unmountandroid() {
    chosen="$(awk '$1 == "simple-mtpfs" {print $2}' /etc/mtab | rofi -dmenu -i -p "Which android?" -no-custom)"
    sudo -A umount -l "${chosen:?}" && notify-send "ðŸ¤– Android unmounting" "${chosen} unmounted."
}

drives="$(lsblk -nrpo "name,type,size,mountpoint" | awk '$2=="part"&&$4!~/\/boot|\/home$|SWAP/&&length($4)>1{printf "%s (%s)\n",$4,$3}')"

if ! grep simple-mtpfs /etc/mtab; then
    if [ -n "${drives}" ]; then
        echo "Unmountable USB drive detected."
        unmountusb "${drives}"
    fi
else
    if [ -z "${drives}" ]; then
        echo "Unmountable Android device detected."
        unmountandroid
    else
        echo "Unmountable USB drive(s) and Android device(s) detected."
        what="$(printf 'usb\nandroid' | rofi -dmenu -i -p "Unmount what?" -no-custom)"
        case "${what:?}" in
            usb) unmountusb "${drives}" ;;
            android) unmountandroid ;;
        esac
    fi
fi
