#!/bin/sh
[ -z "${1}" ] && notify-send "Url is empty"
url="${1:?provide url}"

get_formats() {
    columns='format_id,width,height,ext,filesize,vcodec,acodec'
    jq_format=".formats[] | (\"\(.$(echo "${columns}" | sed 's/,/)|\\(./g'))\")"
    #                                                     "," -> ")|\(."
    ytdl --no-color --dump-json "${url}" \
        | jq --raw-output "${jq_format}" \
        | column --table --separator '|'
}

select_format() {
    menu -p "Select format" -lines 19
}


case "$(printf "video\naudio\nmusic\nselect video" | menu -p "Download")" in
    video)
        if [ -n "${2}" ]; then
            tsp -L "${2}" ytdly "${url}"
        else
            tsp ytdly "${url}"
        fi
        ;;
    audio)
        if [ -n "${2}" ]; then
            tsp -L "${2}" ytdlay "${url}"
        else
            tsp ytdlay "${url}"
        fi
        ;;
    music)
        TSP_TITLE="${2}" ytdlam "${url}"
        ;;
    "select video")
        selected_format="$(get_formats | select_format | awk '{print $1}')"
        chosen_format="${selected_format:?}+bestaudio/${selected_format:?}/best"
        if [ -n "${2}" ]; then
            tsp -L "${2}" ytdly -f "${chosen_format}" "${url}"
        else
            tsp ytdly -f "${chosen_format}" "${url}"
        fi
        ;;
esac
